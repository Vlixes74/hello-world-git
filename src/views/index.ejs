<!DOCTYPE html>
<html lang="es">
<head>
  <%- include('partials/header') %>
  <style>
    /* Estilos personalizados para tablas con scroll */
    .table-scrollable {
      max-height: 500px;
      overflow-y: auto;
    }
    
    /* Fijar encabezados de tabla */
    .sticky-header thead th {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Scrollbar estilo Bootstrap */
    .table-scrollable::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .table-scrollable::-webkit-scrollbar-thumb {
      background-color: #adb5bd;
      border-radius: 4px;
    }
    
    .table-scrollable::-webkit-scrollbar-track {
      background-color: #f8f9fa;
    }
    
    /* Ajustes para listas */
    .list-scrollable {
      max-height: 300px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <%- include('partials/navbar', { isAdmin: user?.isAdmin }) %>
  <div class="container mt-4">
    <% if (error) { %>
      <div class="toast align-items-center text-white bg-danger position-fixed top-0 end-0 m-3" role="alert">
        <div class="d-flex">
          <div class="toast-body"><%= error %></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    <% } %>
    
    <% if (success) { %>
      <div class="toast align-items-center text-white bg-success position-fixed top-0 end-0 m-3" role="alert">
        <div class="d-flex">
          <div class="toast-body"><%= success %></div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    <% } %>

    <div class="row">
      <div class="col-md-8">
        <div class="card mb-4">
          <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-upload"></i> Cargar nuevo archivo CSV
            </h5>
          </div>
          <div class="card-body">
            <form action="/upload" method="POST" enctype="multipart/form-data" id="uploadForm">
              <div class="mb-3">
                <label for="csvFile" class="form-label">Selecciona un archivo CSV</label>
                <input class="form-control" type="file" id="csvFile" name="csvFile" accept=".csv" required>
                <div class="form-text">Tamaño máximo: 5MB</div>
              </div>
              
              <div class="mb-3">
                <label for="collectionName" class="form-label">Colección de destino</label>
                <select class="form-select" id="collectionName" name="collectionName" required>
                  <option value="CodigoQr">Codigos Qr</option>
                </select>
              </div>
              
              <button type="submit" class="btn btn-primary" id="uploadBtn">
                <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner"></span>
                Cargar y Validar
              </button>
            </form>
          </div>
        </div>
        
        <% if (data) { %>
          <div class="card mb-4">
            <div class="card-header bg-info text-white">
              <h5 class="card-title mb-0">
                <i class="bi bi-table"></i> Vista previa (10 primeros registros)
              </h5>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-striped table-hover">
                  <thead class="table-light">
                    <tr>
                      <% const headers = Object.keys(data[0] || {}); %>
                      <% headers.forEach(header => { %>
                        <th><%= header %></th>
                      <% }); %>
                    </tr>
                  </thead>
                  <tbody>
                    <% data.slice(0, 10).forEach(row => { %>
                      <tr>
                        <% headers.forEach(header => { %>
                          <td><%= row[header] %></td>
                        <% }); %>
                      </tr>
                    <% }); %>
                  </tbody>
                </table>
              </div>
              <% if (data.length > 10) { %>
                <p class="text-muted">Mostrando 10 de <%= data.length %> registros</p>
              <% } %>
            </div>
          </div>
        <% } %>
      </div>
      
      <div class="col-md-4">
                <div class="card shadow-sm">
          <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">
              <i class="bi bi-clock-history me-2"></i>Historial de cargas
            </h5>
          </div>
          <div class="card-body p-0">
            <% if (uploads && uploads.length > 0) { %>
              <div class="list-group list-group-flush list-scrollable">
                <% uploads.forEach(upload => { %>
                  <div class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between">
                      <h6 class="mb-1"><%= upload.fileName %></h6>
                      <small class="text-muted">
                        <%= new Date(upload.uploadedAt?.seconds * 1000).toLocaleDateString() %>
                      </small>
                    </div>
                    <p class="mb-1"><%= upload.recordCount %> registros</p>
                    <small class="text-muted">Colección: <%= upload.collectionName %></small>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <div class="text-center py-4 text-muted">
                <i class="bi bi-folder-x fs-1"></i>
                <p class="mt-2 mb-0">No hay cargas anteriores</p>
              </div>
            <% } %>
          </div>
        </div>
        
        <% if (user?.isAdmin) { %>
          <div class="card">
            <div class="card-header bg-danger text-white">
              <h5 class="card-title mb-0">
                <i class="bi bi-trash3"></i> Administración
              </h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label">Borrado Masivo</label>
                <select class="form-select mb-2" id="collectionToDelete">
                  <option value="CodigoQr">Codigos Qr</option>
                </select>
                
                <button type="button" class="btn btn-outline-danger w-100" 
                        data-bs-toggle="modal" data-bs-target="#deleteModal">
                  Eliminar Colección
                </button>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación para Borrado -->
  <% if (user?.isAdmin) { %>
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirmar Borrado Masivo</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <p>¿Estás seguro de querer borrar TODOS los documentos de la colección <strong id="collectionNameText"></strong>?</p>
            <p class="text-danger"><strong>Esta acción no se puede deshacer.</strong></p>
            <form id="deleteForm" method="POST">
              <div class="mb-3">
             <!--   <label for="confirmationText" class="form-label">Escribe "ELIMINAR" para confirmar:</label>
                <input type="text" class="form-control" id="confirmationText" required 
                      pattern="ELIMINAR" title="Debes escribir ELIMINAR para confirmar">-->
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" form="deleteForm" class="btn btn-danger">Confirmar Eliminación</button>
          </div>
        </div>
      </div>
    </div>
  <% } %>

  <%- include('partials/footer') %>

  <script>
    // Script para el modal de borrado
    document.addEventListener('DOMContentLoaded', () => {
      const deleteModal = document.getElementById('deleteModal');
      if (deleteModal) {
        deleteModal.addEventListener('show.bs.modal', (event) => {
          const collectionSelect = document.getElementById('collectionToDelete');
          const collectionNameText = document.getElementById('collectionNameText');
          const deleteForm = document.getElementById('deleteForm');
          
          const collectionName = collectionSelect.value;
          collectionNameText.textContent = collectionName;
          deleteForm.action = `admin/delete-collection/${collectionName}`;
        });
      }

      // Mostrar spinner durante la carga
      const uploadForm = document.getElementById('uploadForm');
      if (uploadForm) {
        uploadForm.addEventListener('submit', () => {
          const uploadBtn = document.getElementById('uploadBtn');
          const uploadSpinner = document.getElementById('uploadSpinner');
          
          uploadBtn.disabled = true;
          uploadSpinner.classList.remove('d-none');
        });
      }
    });
  </script>
</body>
</html>